<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Not Uber</title>
        <link rel="stylesheet" href="style.css">

        <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry" sync defer>
        </script>

        <script type="text/javascript">
            var latitude;
            var longitude;
            var mydata;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    myLatLng = new google.maps.LatLng(latitude, longitude);

                    mydata = "username=OGyGLT4c&lat=" + latitude + "&lng=" + longitude;

                    //console.log(mydata);

                    initMap();
                })
            } else {
                document.getElementById("map").innerHTML = "Geolocation not supported by this browser - download a better one and try again";
            }

            function initMap() {
                map = new google.maps.Map(document.getElementById("map"));

                map.setCenter(myLatLng);
                map.setZoom(14);

                req();
            }

            function req() {
                request = new XMLHttpRequest();

                request.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);

                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                var requestdata;

                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        data = JSON.parse(request.responseText);

                        console.log(data);

                        setSelf();
                    }
                }

                request.send(mydata);
            }

            function setSelf() {
                infowindow = new google.maps.InfoWindow();

                marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map,
                    title: "OGyGLT4c",
                    icon: "black_car.png"
                });

                var myinfo = new google.maps.InfoWindow();

                marker.addListener('click', function () {
                    infowindow.setContent(this.title);
                    infowindow.open(map, this);
                });

                marker.setMap(map);

                setMarkers();
            }

            function setMarkers() {
                var userLatLng;
                for (i = 0; i < data.passengers.length; i++) {
                    userLatLng = new google.maps.LatLng(data.passengers[i].lat, data.passengers[i].lng);

                    marker = new google.maps.Marker({
                        position: userLatLng,
                        map: map,
                        title: data.passengers[i].username
                    });

                    marker.addListener('click', function () {
                        infowindow.setContent(this.title + "<br>" +
                        google.maps.geometry.spherical.computeDistanceBetween(
                            myLatLng, this.position) * 0.000621371 + " miles away");
                        infowindow.open(map, this);
                    });

                    marker.setMap(map);
                }
            }


        </script>
    </head>

    <body>
        <div id="map"></div>
    </body>
</html>
